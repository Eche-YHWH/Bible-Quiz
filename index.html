<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Acts Quiz Arcade</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      :root{
        --ink:#4a2a14;
        --paper:#f6d9a6;
        --paper2:#f3c98a;
        --leather:#8b4f2a;
        --leather2:#6f3b1f;
        --gold:#ffcf4a;
        --gold2:#ffb229;
        --cream:#fff2d1;
      }

      /* soft game bg */
      .bg-art {
        background:
          radial-gradient(1200px 700px at 30% 10%, rgba(255, 223, 127, 0.35), transparent 60%),
          radial-gradient(900px 600px at 80% 30%, rgba(255, 128, 200, 0.18), transparent 55%),
          radial-gradient(900px 700px at 20% 75%, rgba(80, 220, 255, 0.18), transparent 55%),
          linear-gradient(180deg, #f2e5c8, #e8d4aa);
      }

      /* top HUD pill shadow */
      .hud {
        box-shadow: 0 10px 18px rgba(0,0,0,0.25);
      }

      /* parchment */
      .paper {
        background: linear-gradient(180deg, var(--paper), var(--paper2));
        box-shadow: 0 14px 28px rgba(0,0,0,0.25);
        border: 2px solid rgba(124,72,34,0.25);
      }

      /* leather base */
      .leather {
        background: linear-gradient(180deg, var(--leather), var(--leather2));
        border: 2px solid rgba(255,255,255,0.12);
        box-shadow: inset 0 0 0 2px rgba(0,0,0,0.08), 0 14px 28px rgba(0,0,0,0.25);
      }

      .stitch {
        border: 2px dashed rgba(255,255,255,0.18);
      }

      /* answer buttons */
      .answer {
        background: linear-gradient(180deg, var(--gold), var(--gold2));
        border: 2px solid rgba(90, 40, 10, 0.25);
        box-shadow: inset 0 2px 0 rgba(255,255,255,0.65), 0 10px 0 rgba(0,0,0,0.15);
        color: var(--ink);
      }
      .answer:hover { filter: brightness(1.02); }
      .answer:active { transform: translateY(2px); box-shadow: inset 0 2px 0 rgba(255,255,255,0.55), 0 8px 0 rgba(0,0,0,0.15); }
      .answer[disabled]{ opacity: 0.75; filter: saturate(0.9); }

      .badge {
        background: linear-gradient(180deg, #ffe7a8, #ffd066);
        border: 2px solid rgba(90,40,10,0.22);
        box-shadow: inset 0 2px 0 rgba(255,255,255,0.65), 0 8px 14px rgba(0,0,0,0.18);
        color: var(--ink);
      }

      .iconbtn {
        background: linear-gradient(180deg, #ffcf4a, #ffae2a);
        border: 2px solid rgba(90,40,10,0.22);
        box-shadow: inset 0 2px 0 rgba(255,255,255,0.65), 0 10px 0 rgba(0,0,0,0.14);
      }
      .iconbtn:active{ transform: translateY(2px); box-shadow: inset 0 2px 0 rgba(255,255,255,0.55), 0 8px 0 rgba(0,0,0,0.14); }

      /* progress bar */
      .track {
        background: linear-gradient(180deg, #a0602f, #804620);
        box-shadow: inset 0 2px 0 rgba(255,255,255,0.18);
        border: 2px solid rgba(90,40,10,0.18);
      }
      .trackFill {
        background: linear-gradient(180deg, #ffd86b, #ffb836);
        box-shadow: inset 0 2px 0 rgba(255,255,255,0.35);
      }

      .confetti {
        position: fixed;
        inset: 0;
        pointer-events: none;
        overflow: hidden;
        z-index: 50;
      }
      .confetti i {
        position: absolute;
        width: 10px;
        height: 18px;
        opacity: 0.9;
        transform: translateY(-20px) rotate(0deg);
        animation: fall 900ms linear forwards;
        border-radius: 3px;
      }
      @keyframes fall {
        to { transform: translateY(110vh) rotate(360deg); opacity: 1; }
      }

      .shake { animation: shake 0.35s ease-in-out; }
      @keyframes shake {
        0% { transform: translateX(0); }
        25% { transform: translateX(-6px); }
        50% { transform: translateX(6px); }
        75% { transform: translateX(-4px); }
        100% { transform: translateX(0); }
      }

      /* Streak popup animation */
      .pop-in { animation: popIn 180ms ease-out both; }
      @keyframes popIn {
        from { transform: scale(0.96); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
      }

      /* Book map */
      .book-map {
        position: relative;
        height: 420px;
        border-radius: 22px;
        background: linear-gradient(180deg, #f9e7c5, #f0c786);
        border: 2px solid rgba(124,72,34,0.25);
        box-shadow: inset 0 0 0 2px rgba(255,255,255,0.25), 0 10px 18px rgba(0,0,0,0.15);
        overflow: hidden;
      }
      .book-map::before {
        content: "";
        position: absolute;
        inset: 0;
        background-image:
          radial-gradient(circle at 15% 20%, rgba(255,255,255,0.35) 0 3px, transparent 4px),
          radial-gradient(circle at 70% 25%, rgba(255,255,255,0.3) 0 2px, transparent 3px),
          radial-gradient(circle at 35% 55%, rgba(255,255,255,0.3) 0 2px, transparent 3px),
          radial-gradient(circle at 75% 70%, rgba(255,255,255,0.3) 0 2px, transparent 3px),
          radial-gradient(circle at 20% 80%, rgba(255,255,255,0.3) 0 2px, transparent 3px);
        opacity: 0.6;
        pointer-events: none;
      }
      .map-path {
        position: absolute;
        inset: 0;
      }
      .map-path path {
        stroke: rgba(206, 139, 82, 0.9);
        stroke-width: 7;
        fill: none;
        stroke-linecap: round;
        filter: drop-shadow(0 2px 0 rgba(255,255,255,0.35));
      }
      .book-node-wrap {
        position: absolute;
        transform: translate(-50%, -50%);
        text-align: center;
        width: 92px;
        z-index: 2;
      }
      .book-node {
        width: 64px;
        height: 64px;
        margin: 0 auto;
        border-radius: 999px;
        background: linear-gradient(180deg, #fff7dc, #ffd7a5);
        border: 3px solid rgba(120,70,30,0.28);
        box-shadow: inset 0 2px 0 rgba(255,255,255,0.7), 0 8px 0 rgba(0,0,0,0.12);
        color: var(--ink);
        display: grid;
        place-items: center;
        font-weight: 900;
        letter-spacing: 0.5px;
        cursor: pointer;
        transition: transform 120ms ease, filter 120ms ease, box-shadow 120ms ease;
      }
      .book-node:hover { filter: brightness(1.03); transform: translateY(-1px); }
      .book-node:active { transform: translateY(1px); box-shadow: inset 0 2px 0 rgba(255,255,255,0.6), 0 6px 0 rgba(0,0,0,0.12); }
      .book-node.active {
        outline: 3px solid rgba(255, 200, 60, 0.65);
        box-shadow: 0 0 0 4px rgba(255, 207, 74, 0.4), inset 0 2px 0 rgba(255,255,255,0.7), 0 8px 0 rgba(0,0,0,0.12);
      }
      .book-label {
        margin-top: 6px;
        font-size: 0.7rem;
        font-weight: 800;
      }
    </style>
  </head>

  <body class="min-h-screen bg-art">
    <div id="confetti" class="confetti hidden"></div>

    <!-- Background music -->
    <audio id="bgMusic" src="./fairy-tale-loop-275534.mp3" loop preload="auto"></audio>

    <!-- Menu Screen -->
    <div id="menu" class="fixed inset-0 z-40 flex items-center justify-center bg-black/50 p-4">
      <div class="paper w-full max-w-md rounded-3xl p-6 text-[color:var(--ink)]">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-2xl font-black">Acts Quiz Arcade</h2>
            <p class="mt-1 text-sm font-semibold opacity-80">Pick a mode.</p>
          </div>
          <div class="text-3xl">ü™Ω</div>
        </div>

        <div class="mt-5 grid gap-3">
          <button id="btnNewGame" class="answer w-full rounded-2xl px-4 py-4 font-black text-lg">New game</button>
          <button id="btnContinue" class="answer w-full rounded-2xl px-4 py-4 font-black text-lg">Continue</button>
        </div>

        <div class="mt-4 badge rounded-2xl px-4 py-3 text-sm font-semibold">
          <div class="flex items-center justify-between">
            <span>Best</span>
            <span id="bestScoreMenu" class="font-black">0</span>
          </div>
          <div class="mt-2 flex items-center justify-between">
            <span>Saved run</span>
            <span id="saveStatus" class="font-black">None</span>
          </div>
        </div>

        <p class="mt-4 text-xs font-semibold opacity-75">
          Tip: Keep a streak. Every 3 correct gives a bonus.
        </p>
      </div>
    </div>

    <!-- Book Map -->
    <div id="bookMap" class="fixed inset-0 z-40 hidden items-center justify-center bg-black/50 p-4">
      <div class="paper w-full max-w-md rounded-3xl p-5 text-[color:var(--ink)]">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-2xl font-black">Bible Book Map</h2>
            <p class="mt-1 text-sm font-semibold opacity-80">Pick a book to start.</p>
          </div>
          <button id="btnCloseMap" class="badge rounded-xl px-3 py-2 font-black">Back</button>
        </div>

        <div class="mt-4 book-map">
          <svg class="map-path" viewBox="0 0 100 100" preserveAspectRatio="none" aria-hidden="true">
            <path d="M10 15 C 30 5, 45 25, 70 20 S 95 30, 85 40 C 75 52, 55 45, 45 60 S 30 75, 22 80 S 40 92, 72 88" />
          </svg>
          <div id="bookNodes" class="absolute inset-0"></div>
        </div>

        <div class="mt-4 flex items-center justify-between text-xs font-semibold opacity-80">
          <span id="mapHint">Tap a book to begin.</span>
          <span id="selectedBookLabel" class="font-black"></span>
        </div>
      </div>
    </div>

    <!-- Streak popup (tap anywhere to continue) -->
    <div id="streakPop" class="fixed inset-0 z-40 hidden items-center justify-center bg-black/40 p-4">
      <img
        id="streakPopImg"
        src="./streak_popup_transparent.png"
        alt="Streak bonus"
        class="pop-in w-full max-w-sm rounded-3xl shadow-2xl active:scale-[0.99] transition"
      />
    </div>

    <main class="mx-auto max-w-md px-4 py-6">
      <!-- HUD -->
      <header class="hud flex items-center justify-between rounded-2xl bg-white/30 backdrop-blur-sm px-3 py-2 border border-white/30">
        <div class="flex items-center gap-2">
          <div class="grid h-9 w-9 place-items-center rounded-xl bg-cyan-300/90 border border-white/40 shadow">
            <span class="text-xl">üíé</span>
          </div>
          <div class="badge rounded-xl px-3 py-2 font-extrabold leading-none">
            <span id="gemCount">9999</span>
          </div>
          <button id="btnAddGems" class="iconbtn grid h-9 w-9 place-items-center rounded-xl" title="Bonus">
            <span class="text-lg">Ôºã</span>
          </button>
        </div>

        <div class="flex items-center gap-2">
          <button id="btnReset" class="iconbtn grid h-9 w-9 place-items-center rounded-xl" title="Restart">
            <span class="text-lg">‚Ü©</span>
          </button>
          <button id="btnHow" class="iconbtn grid h-9 w-9 place-items-center rounded-xl" title="How to play">
            <span class="text-lg">‚öô</span>
          </button>
        </div>
      </header>

      <!-- Progress -->
      <section class="mt-4">
        <div class="flex items-center gap-3">
          <span class="text-2xl">‚≠ê</span>
          <div class="track relative h-4 flex-1 rounded-full overflow-hidden">
            <div id="progressFill" class="trackFill absolute left-0 top-0 h-full w-0"></div>
          </div>
          <span class="text-2xl">‚≠ê</span>
        </div>
        <div class="mt-2 flex items-center justify-between text-sm text-[color:var(--ink)] font-extrabold">
          <span id="statBookName">Acts</span>
          <span id="statProgress">1/30</span>
        </div>
        <div id="statLevelName" class="mt-1 text-xs font-semibold text-[color:var(--ink)] opacity-80">New Fire</div>
      </section>

      <!-- Question parchment -->
      <section id="paperCard" class="paper mt-4 rounded-3xl px-5 py-6">
        <div class="text-[color:var(--ink)]">
          <p class="text-3xl font-black leading-tight" id="qText">Loading...</p>
        </div>

        <div class="mt-4 flex items-center justify-between">
          <!-- hearts -->
          <div class="flex items-center gap-2">
            <div id="statLives" class="flex gap-1"></div>
          </div>

          <!-- timer badge (visual only) -->
          <div class="badge rounded-2xl px-3 py-2 flex items-center gap-2">
            <span class="text-lg">‚è±</span>
            <span class="font-black" id="timerLabel">15s</span>
          </div>
        </div>
      </section>

      <!-- Answers leather board -->
      <section id="board" class="leather mt-4 rounded-3xl p-4">
        <div class="stitch rounded-2xl p-3">
          <div id="choices" class="grid gap-3"></div>
        </div>

        <div id="feedback" class="mt-4 hidden rounded-2xl px-4 py-3 text-sm"></div>

        <div class="mt-4 flex items-center gap-2">
          <button id="btnNext" class="hidden answer w-full rounded-2xl px-4 py-3 font-black text-lg">Next</button>
          <button id="btnRestart" class="hidden answer w-full rounded-2xl px-4 py-3 font-black text-lg">Play again</button>
        </div>

        <div class="mt-3 flex items-center justify-between">
          <div class="badge rounded-2xl px-3 py-2">
            <span class="font-black">Score:</span> <span id="statScore" class="font-black">0</span>
            <span class="opacity-70"> | </span>
            <span class="font-black">Streak:</span> <span id="statStreak" class="font-black">0</span>
          </div>

          <button id="btnSound" class="badge rounded-2xl px-3 py-2 font-black">Sound: On</button>
        </div>

        <div class="mt-3 text-xs text-white/75">
          <span class="font-semibold">Best:</span> <span id="bestScore">0</span>
          <span class="opacity-70"> | </span>
          <span class="font-semibold">Rank:</span> <span id="rank">Fresh Learner</span>
        </div>
      </section>

      <!-- Modal -->
      <div id="modal" class="fixed inset-0 hidden items-center justify-center bg-black/60 p-4 z-40">
        <div class="paper w-full max-w-lg rounded-3xl p-5">
          <div class="flex items-start justify-between gap-3 text-[color:var(--ink)]">
            <div>
              <h3 class="text-lg font-black">How to play</h3>
              <p class="text-sm opacity-80 mt-1">Quick rules so you can start fast.</p>
            </div>
            <button id="btnClose" class="badge rounded-xl px-3 py-2 font-black">Close</button>
          </div>

          <ul class="mt-4 space-y-2 text-sm text-[color:var(--ink)] font-semibold list-disc pl-5">
            <li>Questions are split into levels (6 each). Total varies by book.</li>
            <li>Correct answer: +10 points.</li>
            <li>Wrong answer: lose 1 life (you have 3).</li>
            <li>Streak bonus: every 3 correct in a row gives +5.</li>
            <li>Level-up pops confetti. Finish all questions to get your rank.</li>
            <li>Keyboard: A/B/C/D to answer, Enter for next.</li>
          </ul>
        </div>
      </div>
    </main>

    <script>
      // ---------- Audio (FX + BG music) ----------
      const AUDIO = {
        correct: "./correct-156911.mp3",
        streak: "./correct-472358.mp3",
      };

      // ---------- Data ----------
      const QUESTIONS_PER_LEVEL = 6;

      const LEVELS = {
        1: { name: "New Fire (Acts 1-6)" },
        2: { name: "The Way Spreads (Acts 7-12)" },
        3: { name: "Across Cities (Acts 13-18)" },
        4: { name: "Truth on Trial (Acts 19-24)" },
        5: { name: "Rome at Last (Acts 25-28)" },
      };

      const QUESTIONS = [
        // Level 1
        { level: 1, question: "Before Jesus ascended, what did He tell the disciples to wait for in Jerusalem?", options: { A: "More teachings", B: "The Holy Spirit", C: "Bread and wine", D: "A new king" }, answer: "B", ref: "Acts 1:4-5" },
        { level: 1, question: "Who replaced Judas as the 12th apostle?", options: { A: "Matthias", B: "Barnabas", C: "Paul", D: "Silas" }, answer: "A", ref: "Acts 1:26" },
        { level: 1, question: "What happened on the day of Pentecost?", options: { A: "Earthquake", B: "The Holy Spirit came with tongues of fire", C: "A flood", D: "Angels appeared" }, answer: "B", ref: "Acts 2:1-4" },
        { level: 1, question: "Peter‚Äôs first sermon led to how many people being added in one day?", options: { A: "70", B: "120", C: "3,000", D: "5,000" }, answer: "C", ref: "Acts 2:41" },
        { level: 1, question: "What miracle did Peter and John do at the Beautiful Gate?", options: { A: "Healed a blind man", B: "Healed a lame man", C: "Raised a dead man", D: "Cast out a legion" }, answer: "B", ref: "Acts 3:1-10" },
        { level: 1, question: "Why were deacons chosen in Acts 6?", options: { A: "To lead worship", B: "To care for widows fairly", C: "To write letters", D: "To arrest criminals" }, answer: "B", ref: "Acts 6:1-6" },

        // Level 2
        { level: 2, question: "Who was the first Christian martyr?", options: { A: "James", B: "Stephen", C: "Peter", D: "Philip" }, answer: "B", ref: "Acts 7:54-60" },
        { level: 2, question: "Who preached in Samaria and many believed?", options: { A: "Philip", B: "Thomas", C: "Andrew", D: "Matthew" }, answer: "A", ref: "Acts 8:5-8" },
        { level: 2, question: "Who was baptized after reading Isaiah with Philip?", options: { A: "A Roman soldier", B: "An Ethiopian eunuch", C: "A synagogue ruler", D: "A tax collector" }, answer: "B", ref: "Acts 8:26-39" },
        { level: 2, question: "Who met Jesus on the road to Damascus and became an apostle?", options: { A: "Saul", B: "Apollos", C: "Timothy", D: "Mark" }, answer: "A", ref: "Acts 9:1-6" },
        { level: 2, question: "Who was raised from the dead by Peter in Joppa?", options: { A: "Tabitha (Dorcas)", B: "Mary Magdalene", C: "Jezebel", D: "Martha" }, answer: "A", ref: "Acts 9:36-41" },
        { level: 2, question: "Who was the centurion whose household received the Holy Spirit?", options: { A: "Cornelius", B: "Julius", C: "Longinus", D: "Tertullus" }, answer: "A", ref: "Acts 10:1-2" },

        // Level 3
        { level: 3, question: "Who went with Paul on his first missionary journey?", options: { A: "Silas", B: "Barnabas", C: "Luke", D: "Peter" }, answer: "B", ref: "Acts 13:2-3" },
        { level: 3, question: "What was the main debate at the Jerusalem Council (Acts 15)?", options: { A: "Should believers keep the Sabbath?", B: "Should Gentiles be circumcised to be saved?", C: "Should Rome be resisted?", D: "Should the church build temples?" }, answer: "B", ref: "Acts 15:1-11" },
        { level: 3, question: "In Philippi, who was the first convert mentioned, a seller of purple?", options: { A: "Lydia", B: "Dorcas", C: "Priscilla", D: "Drusilla" }, answer: "A", ref: "Acts 16:14-15" },
        { level: 3, question: "In Philippi, Paul and Silas sang hymns in prison. What happened next?", options: { A: "Fire came down", B: "An earthquake opened the doors", C: "The guards ran away", D: "Paul fainted" }, answer: "B", ref: "Acts 16:25-26" },
        { level: 3, question: "At Athens, where did Paul preach about the 'Unknown God'?", options: { A: "The Temple", B: "The marketplace only", C: "The Areopagus", D: "A prison courtyard" }, answer: "C", ref: "Acts 17:22-23" },
        { level: 3, question: "In Acts 18, who explained the way of God more accurately to Apollos?", options: { A: "Aquila and Priscilla", B: "James and John", C: "Peter and Andrew", D: "Philip and Stephen" }, answer: "A", ref: "Acts 18:26" },

        // Level 4
        { level: 4, question: "In Ephesus, people burned what after turning from sin?", options: { A: "Their clothes", B: "Their magic books", C: "Their fishing nets", D: "Their scrolls of law" }, answer: "B", ref: "Acts 19:19" },
        { level: 4, question: "Who was the young man who fell from a window but was revived by Paul?", options: { A: "Titus", B: "Eutychus", C: "Onesimus", D: "Simeon" }, answer: "B", ref: "Acts 20:9-10" },
        { level: 4, question: "Why was Paul arrested in Jerusalem?", options: { A: "He stole money", B: "He was accused of defiling the temple", C: "He attacked a soldier", D: "He refused to pay taxes" }, answer: "B", ref: "Acts 21:27-36" },
        { level: 4, question: "What was Paul‚Äôs citizenship that protected him from being beaten unlawfully?", options: { A: "Greek", B: "Roman", C: "Egyptian", D: "Syrian" }, answer: "B", ref: "Acts 22:25-28" },
        { level: 4, question: "Paul said he was on trial because of hope in what doctrine?", options: { A: "Prosperity", B: "Resurrection of the dead", C: "Angels", D: "The law of Moses" }, answer: "B", ref: "Acts 23:6" },
        { level: 4, question: "Who trembled when Paul spoke about righteousness and judgment to come?", options: { A: "Felix", B: "Cornelius", C: "Stephen", D: "Gamaliel" }, answer: "A", ref: "Acts 24:24-25" },

        // Level 5
        { level: 5, question: "To whom did Paul appeal, using his rights as a Roman citizen?", options: { A: "The Sanhedrin", B: "Caesar", C: "The high priest", D: "The centurion" }, answer: "B", ref: "Acts 25:10-12" },
        { level: 5, question: "Which king heard Paul‚Äôs defense and said 'Almost you persuade me'?", options: { A: "Herod", B: "Agrippa", C: "Caesar", D: "Nero" }, answer: "B", ref: "Acts 26:28" },
        { level: 5, question: "During the storm at sea, what did Paul say God promised about everyone on the ship?", options: { A: "Many would die", B: "All would be saved", C: "Only Paul would live", D: "The ship would not break" }, answer: "B", ref: "Acts 27:22-24" },
        { level: 5, question: "After the shipwreck, which island did they land on?", options: { A: "Patmos", B: "Cyprus", C: "Malta", D: "Crete" }, answer: "C", ref: "Acts 28:1" },
        { level: 5, question: "On Malta, what happened to Paul when a viper bit him?", options: { A: "He died instantly", B: "His hand swelled badly", C: "Nothing happened", D: "He became blind" }, answer: "C", ref: "Acts 28:3-6" },
        { level: 5, question: "How does the book of Acts end (final setting)?", options: { A: "Paul in a palace", B: "Paul in prison in Jerusalem", C: "Paul preaching in Rome under house arrest", D: "Peter ruling the church" }, answer: "C", ref: "Acts 28:30-31" },
      ];

      const BOOKS = {
        acts: { title: "Acts", short: "Acts", pos: { x: 40, y: 78 }, levels: LEVELS, questions: QUESTIONS },
        genesis: {
          title: "Genesis",
          short: "Gen",
          pos: { x: 12, y: 18 },
          questions: [
            { question: "On which day did God create the sun, moon, and stars?", options: { A: "Day 1", B: "Day 2", C: "Day 3", D: "Day 4" }, answer: "D", ref: "Genesis 1:14-19" },
            { question: "Who was the first man created by God?", options: { A: "Noah", B: "Adam", C: "Abraham", D: "Jacob" }, answer: "B", ref: "Genesis 2:7" },
            { question: "What was the name of Abraham's wife?", options: { A: "Rebekah", B: "Rachel", C: "Sarah", D: "Leah" }, answer: "C", ref: "Genesis 17:15" },
            { question: "What sign did God give Noah that He would never again destroy the earth by flood?", options: { A: "Rainbow", B: "Dove", C: "Olive branch", D: "Ark" }, answer: "A", ref: "Genesis 9:13" },
            { question: "Jacob dreamed of a ladder reaching to heaven. What place did he name?", options: { A: "Beersheba", B: "Bethel", C: "Hebron", D: "Shechem" }, answer: "B", ref: "Genesis 28:12-19" },
            { question: "Who was sold into slavery by his brothers?", options: { A: "Joseph", B: "Benjamin", C: "Esau", D: "Isaac" }, answer: "A", ref: "Genesis 37:28" },
          ],
        },
        exodus: {
          title: "Exodus",
          short: "Exo",
          pos: { x: 70, y: 22 },
          questions: [
            { question: "What did Moses see that burned but was not consumed?", options: { A: "Burning bush", B: "Pillar of cloud", C: "Golden calf", D: "Mount Sinai" }, answer: "A", ref: "Exodus 3:2" },
            { question: "What was the first plague on Egypt?", options: { A: "Frogs", B: "Water turned to blood", C: "Darkness", D: "Locusts" }, answer: "B", ref: "Exodus 7:20" },
            { question: "Who was Moses' brother and spokesman?", options: { A: "Aaron", B: "Joshua", C: "Caleb", D: "Miriam" }, answer: "A", ref: "Exodus 4:14-16" },
            { question: "What did God give Moses on Mount Sinai?", options: { A: "Ark plans", B: "Ten Commandments", C: "Manna", D: "A new staff" }, answer: "B", ref: "Exodus 20:1-17" },
            { question: "What was the bread-like food God provided in the wilderness?", options: { A: "Quail", B: "Manna", C: "Figs", D: "Barley" }, answer: "B", ref: "Exodus 16:15" },
            { question: "What sea did the Israelites cross when leaving Egypt?", options: { A: "Sea of Galilee", B: "Red Sea", C: "Dead Sea", D: "Mediterranean Sea" }, answer: "B", ref: "Exodus 14:21-22" },
          ],
        },
        psalms: {
          title: "Psalms",
          short: "Psa",
          pos: { x: 30, y: 46 },
          questions: [
            { question: "\"The Lord is my shepherd; I shall not want\" is from which Psalm?", options: { A: "Psalm 1", B: "Psalm 19", C: "Psalm 23", D: "Psalm 100" }, answer: "C", ref: "Psalm 23:1" },
            { question: "Psalm 19 says the heavens declare the ___ of God.", options: { A: "power", B: "mercy", C: "glory", D: "law" }, answer: "C", ref: "Psalm 19:1" },
            { question: "Psalm 46 says, \"Be still, and know that I am ___.\"", options: { A: "king", B: "God", C: "holy", D: "love" }, answer: "B", ref: "Psalm 46:10" },
            { question: "Psalm 100 says, \"Enter his gates with ___.\"", options: { A: "fear", B: "thanksgiving", C: "silence", D: "offerings" }, answer: "B", ref: "Psalm 100:4" },
            { question: "Psalm 119 says God's word is a lamp to my ___.", options: { A: "hands", B: "feet", C: "ears", D: "eyes" }, answer: "B", ref: "Psalm 119:105" },
            { question: "Psalm 150 says to praise God with the sound of the ___.", options: { A: "trumpet", B: "harp", C: "tambourine", D: "cymbals" }, answer: "A", ref: "Psalm 150:3" },
          ],
        },
        john: {
          title: "John",
          short: "John",
          pos: { x: 72, y: 56 },
          questions: [
            { question: "John 1:1 says the Word was with God, and the Word was ___.", options: { A: "Light", B: "God", C: "Spirit", D: "Life" }, answer: "B", ref: "John 1:1" },
            { question: "What was Jesus' first miracle in John?", options: { A: "Healing a leper", B: "Feeding the 5,000", C: "Water into wine", D: "Walking on water" }, answer: "C", ref: "John 2:1-11" },
            { question: "Who came to Jesus at night to ask about being born again?", options: { A: "Nicodemus", B: "Zacchaeus", C: "Jairus", D: "Thomas" }, answer: "A", ref: "John 3:1-3" },
            { question: "John 3:16 says God so loved the world that He gave His only ___.", options: { A: "servant", B: "Son", C: "prophet", D: "king" }, answer: "B", ref: "John 3:16" },
            { question: "Who did Jesus meet at the well in John 4?", options: { A: "A Samaritan woman", B: "Martha", C: "Mary Magdalene", D: "An Ethiopian eunuch" }, answer: "A", ref: "John 4:7-9" },
            { question: "In John 10, Jesus says, \"I am the ___ shepherd\".", options: { A: "great", B: "good", C: "faithful", D: "chosen" }, answer: "B", ref: "John 10:11" },
          ],
        },
        romans: {
          title: "Romans",
          short: "Rom",
          pos: { x: 74, y: 88 },
          questions: [
            { question: "Romans 1:16 says Paul is not ashamed of the ___.", options: { A: "law", B: "gospel", C: "temple", D: "cross" }, answer: "B", ref: "Romans 1:16" },
            { question: "Romans 3:23 says all have sinned and fall short of the ___ of God.", options: { A: "love", B: "glory", C: "mercy", D: "peace" }, answer: "B", ref: "Romans 3:23" },
            { question: "Romans 5:8 says while we were still sinners, Christ ___ for us.", options: { A: "prayed", B: "died", C: "rose", D: "ruled" }, answer: "B", ref: "Romans 5:8" },
            { question: "Romans 6:23 says the wages of sin is death, but the gift of God is ___.", options: { A: "wisdom", B: "eternal life", C: "prosperity", D: "forgiveness" }, answer: "B", ref: "Romans 6:23" },
            { question: "Romans 8:1 says there is now no ___ for those in Christ Jesus.", options: { A: "fear", B: "condemnation", C: "weakness", D: "death" }, answer: "B", ref: "Romans 8:1" },
            { question: "Romans 12:2 says be transformed by the renewing of your ___.", options: { A: "heart", B: "mind", C: "strength", D: "spirit" }, answer: "B", ref: "Romans 12:2" },
          ],
        },
      };

      const BOOK_ORDER = ["genesis", "exodus", "psalms", "john", "acts", "romans"];
      let ACTIVE_BOOK_ID = "acts";
      let ACTIVE_BOOK = BOOKS[ACTIVE_BOOK_ID];
      let ACTIVE_QUESTIONS = ACTIVE_BOOK.questions;
      let ACTIVE_LEVELS = ACTIVE_BOOK.levels || {};

      function buildAutoLevels(title, total) {
        const levels = {};
        const count = Math.max(1, Math.ceil(total / QUESTIONS_PER_LEVEL));
        for (let i = 1; i <= count; i++) {
          levels[i] = { name: `${title} - Level ${i}` };
        }
        return levels;
      }

      function setActiveBook(bookId) {
        const book = BOOKS[bookId];
        if (!book) return;
        ACTIVE_BOOK_ID = bookId;
        ACTIVE_BOOK = book;
        ACTIVE_QUESTIONS = (book.questions || []).map((q, i) => ({
          ...q,
          level: q.level ?? Math.floor(i / QUESTIONS_PER_LEVEL) + 1,
        }));
        ACTIVE_LEVELS = book.levels || buildAutoLevels(book.title, ACTIVE_QUESTIONS.length);
      }

      function resolveBookId(bookId) {
        return BOOKS[bookId] ? bookId : "acts";
      }

      // ---------- State ----------
      let state;
      function freshState() {
        return {
          idx: 0,
          score: 0,
          lives: 3,
          streak: 0,
          answered: false,
          finished: false,
          sound: true,     // controls FX + BG music
          gemCount: 9999,
        };
      }

      // ---------- DOM ----------
      const el = (id) => document.getElementById(id);
      const qText = el("qText");
      const choices = el("choices");
      const feedback = el("feedback");
      const btnNext = el("btnNext");
      const btnRestart = el("btnRestart");
      const btnReset = el("btnReset");
      const btnHow = el("btnHow");
      const modal = el("modal");
      const btnClose = el("btnClose");
      const btnSound = el("btnSound");
      const confetti = el("confetti");
      const progressFill = el("progressFill");
      const statProgress = el("statProgress");
      const statLives = el("statLives");
      const statScore = el("statScore");
      const statStreak = el("statStreak");
      const statLevelName = el("statLevelName");
      const statBookName = el("statBookName");
      const bestScoreEl = el("bestScore");
      const rankEl = el("rank");
      const gemCountEl = el("gemCount");
      const btnAddGems = el("btnAddGems");
      const menu = el("menu");
      const bookMap = el("bookMap");
      const bookNodes = el("bookNodes");
      const btnCloseMap = el("btnCloseMap");
      const mapHint = el("mapHint");
      const selectedBookLabel = el("selectedBookLabel");
      const btnNewGame = el("btnNewGame");
      const btnContinue = el("btnContinue");
      const bestScoreMenu = el("bestScoreMenu");
      const saveStatus = el("saveStatus");
      const bgMusic = el("bgMusic");

      // Streak popup
      const streakPop = el("streakPop");
      const streakPopImg = el("streakPopImg");

      // ---------- Sound ----------
      let audioCtx;
      function beep(type) {
        if (!state.sound) return;
        try {
          audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
          const o = audioCtx.createOscillator();
          const g = audioCtx.createGain();
          o.type = "sine";
          o.frequency.value = type === "good" ? 660 : type === "level" ? 880 : 220;
          g.gain.value = 0.06;
          o.connect(g); g.connect(audioCtx.destination);
          o.start();
          o.stop(audioCtx.currentTime + 0.12);
        } catch (_) {}
      }

      function playFX(kind) {
        if (!state.sound) return;
        try {
          const a = new Audio(AUDIO[kind]);
          a.volume = 0.9;
          a.play().catch(() => {
            beep(kind === "streak" ? "level" : "good");
          });
        } catch (e) {
          beep(kind === "streak" ? "level" : "good");
        }
      }

      function startBgMusic() {
        if (!state.sound) return;
        if (!bgMusic) return;
        bgMusic.volume = 0.32;
        bgMusic.play().catch(() => {
          // Autoplay may be blocked until a click, this is fine.
        });
      }

      function stopBgMusic() {
        if (!bgMusic) return;
        bgMusic.pause();
        bgMusic.currentTime = 0;
      }

      // ---------- Confetti ----------
      function popConfetti() {
        confetti.innerHTML = "";
        confetti.classList.remove("hidden");

        const colors = ["#22c55e", "#60a5fa", "#f472b6", "#fbbf24", "#a78bfa", "#34d399"];
        const count = 80;

        for (let i = 0; i < count; i++) {
          const piece = document.createElement("i");
          const left = Math.random() * 100;
          const delay = Math.random() * 120;
          const color = colors[Math.floor(Math.random() * colors.length)];
          const w = 6 + Math.random() * 8;
          const h = 10 + Math.random() * 14;

          piece.style.left = left + "vw";
          piece.style.top = "-20px";
          piece.style.background = color;
          piece.style.width = w + "px";
          piece.style.height = h + "px";
          piece.style.animationDelay = delay + "ms";
          piece.style.transform = `translateY(-20px) rotate(${Math.random() * 360}deg)`;

          confetti.appendChild(piece);
        }

        setTimeout(() => confetti.classList.add("hidden"), 1200);
      }

      // ---------- Storage / rank ----------
      const BEST_KEY_PREFIX = "acts_quiz_best_v3_";
      const SAVE_KEY = "acts_quiz_save_v3";
      const LAST_BOOK_KEY = "acts_quiz_last_book_v3";

      function bestKey(bookId) {
        return `${BEST_KEY_PREFIX}${bookId}`;
      }
      function getBestScore(bookId = ACTIVE_BOOK_ID) {
        const key = bestKey(bookId);
        const stored = localStorage.getItem(key);
        if (stored !== null) return Number(stored);
        if (bookId === "acts") {
          const legacy = localStorage.getItem("acts_quiz_best_v3");
          if (legacy !== null) {
            localStorage.setItem(key, legacy);
            return Number(legacy);
          }
        }
        return 0;
      }
      function setBestScore(bookId, v) {
        localStorage.setItem(bestKey(bookId), String(v));
      }

      function readSave() {
        try {
          const raw = localStorage.getItem(SAVE_KEY);
          return raw ? JSON.parse(raw) : null;
        } catch {
          return null;
        }
      }
      function writeSave() {
        try {
          const payload = {
            bookId: ACTIVE_BOOK_ID,
            idx: state.idx,
            score: state.score,
            lives: state.lives,
            streak: state.streak,
            finished: state.finished,
            gemCount: state.gemCount,
            total: ACTIVE_QUESTIONS.length,
          };
          localStorage.setItem(SAVE_KEY, JSON.stringify(payload));
        } catch {}
      }
      function clearSave() {
        localStorage.removeItem(SAVE_KEY);
      }

      function calcRank(score) {
        const base = ACTIVE_QUESTIONS.length * 10;
        if (base <= 0) return "Fresh Learner";
        if (score >= Math.round(base * 0.9)) return `${ACTIVE_BOOK.title} Grandmaster`;
        if (score >= Math.round(base * 0.7)) return "Kingdom Builder";
        if (score >= Math.round(base * 0.5)) return "Growing Disciple";
        return "Fresh Learner";
      }

      // ---------- UI helpers ----------
      function renderLives() {
        statLives.innerHTML = "";
        for (let i = 0; i < 3; i++) {
          const span = document.createElement("span");
          span.className = "text-2xl";
          span.textContent = i < state.lives ? "‚ù§" : "üñ§";
          statLives.appendChild(span);
        }
      }

      function setFeedback(type, html) {
        feedback.classList.remove("hidden");
        feedback.className = "mt-4 rounded-2xl px-4 py-3 text-sm";
        if (type === "good") {
          feedback.classList.add("bg-emerald-500/20", "border", "border-emerald-200/30", "text-white");
        } else {
          feedback.classList.add("bg-rose-500/20", "border", "border-rose-200/30", "text-white");
        }
        feedback.innerHTML = html;
      }

      function lockChoices() {
        [...choices.querySelectorAll("button")].forEach((b) => (b.disabled = true));
      }

      function renderProgress() {
        const total = ACTIVE_QUESTIONS.length;
        const current = Math.min(state.idx + 1, total);
        const pct = total ? Math.round(((current - 1) / total) * 100) : 0;
        progressFill.style.width = pct + "%";
        statProgress.textContent = `${current}/${total}`;
      }

      function renderMeta() {
        const q = ACTIVE_QUESTIONS[state.idx] || ACTIVE_QUESTIONS[0];
        const levelName = q ? (ACTIVE_LEVELS[q.level]?.name || `Level ${q.level}`) : "No questions";
        statBookName.textContent = ACTIVE_BOOK.title;
        statLevelName.textContent = levelName;
        statScore.textContent = String(state.score);
        statStreak.textContent = String(state.streak);
        bestScoreEl.textContent = String(getBestScore(ACTIVE_BOOK_ID));
        rankEl.textContent = calcRank(state.score);
        gemCountEl.textContent = String(state.gemCount);
      }

      function renderQuestion() {
        const q = ACTIVE_QUESTIONS[state.idx];
        if (!q) {
          qText.textContent = "No questions loaded.";
          choices.innerHTML = "";
          feedback.classList.add("hidden");
          btnNext.classList.add("hidden");
          btnRestart.classList.add("hidden");
          renderLives();
          renderProgress();
          renderMeta();
          return;
        }

        qText.textContent = q.question; // no "1/30" prefix here
        choices.innerHTML = "";
        feedback.classList.add("hidden");
        btnNext.classList.add("hidden");
        btnRestart.classList.add("hidden");

        const letters = ["A", "B", "C", "D"];
        for (const letter of letters) {
          const label = q.options[letter];
          const btn = document.createElement("button");
          btn.className = "answer w-full rounded-2xl px-4 py-4 font-black text-lg text-left";
          btn.innerHTML = `${letter}. ${label}`;
          btn.addEventListener("click", () => answer(letter));
          choices.appendChild(btn);
        }

        renderLives();
        renderProgress();
        renderMeta();
      }

      // ---------- Streak popup ----------
      function showStreakPopup() {
        // replay pop animation
        streakPopImg.classList.remove("pop-in");
        void streakPopImg.offsetWidth;
        streakPopImg.classList.add("pop-in");

        streakPop.classList.remove("hidden");
        streakPop.classList.add("flex");
      }

      function hideStreakPopup() {
        streakPop.classList.add("hidden");
        streakPop.classList.remove("flex");
      }

      streakPop.addEventListener("click", hideStreakPopup);
      streakPopImg.addEventListener("click", hideStreakPopup);

      function answer(letter) {
        if (state.answered || state.finished) return;

        const q = ACTIVE_QUESTIONS[state.idx];
        state.answered = true;
        lockChoices();

        const correct = letter === q.answer;

        if (correct) {
          state.score += 10;
          state.streak += 1;

          if (state.streak % 3 === 0) {
            state.score += 5;
            setFeedback("good", `<div class="font-black">Correct! +10</div><div class="mt-1">Streak bonus: +5</div>`);
            playFX("streak");
            showStreakPopup();
            popConfetti();
          } else {
            setFeedback("good", `<div class="font-black">Correct! +10</div>`);
            playFX("correct");
          }
        } else {
          state.lives -= 1;
          state.streak = 0;

          const correctText = q.options[q.answer];
          setFeedback(
            "bad",
            `<div class="font-black">Wrong. -1 life</div><div class="mt-1">Correct: <span class="font-black">${q.answer}. ${correctText}</span></div><div class="mt-2 text-xs opacity-80">Reference: ${q.ref}</div>`
          );

          const card = document.getElementById("paperCard");
          card.classList.add("shake");
          setTimeout(() => card.classList.remove("shake"), 380);

          beep("bad");
        }

        renderLives();
        renderMeta();

        if (state.lives <= 0) {
          endGame(false);
          return;
        }

        // Level-up confetti after each level
        const nextIdx = state.idx + 1;
        if (nextIdx % QUESTIONS_PER_LEVEL === 0 && nextIdx < ACTIVE_QUESTIONS.length) {
          beep("level");
          popConfetti();
        }

        btnNext.classList.remove("hidden");
        writeSave();
      }

      function next() {
        if (!state.answered || state.finished) return;

        state.idx += 1;
        state.answered = false;

        if (state.idx >= ACTIVE_QUESTIONS.length) {
          endGame(true);
          return;
        }

        renderQuestion();
        writeSave();
      }

      function endGame(won) {
        state.finished = true;
        clearSave();
        btnNext.classList.add("hidden");
        choices.innerHTML = "";

        const best = getBestScore();
        if (state.score > best) setBestScore(ACTIVE_BOOK_ID, state.score);

        renderMeta();

        const q = ACTIVE_QUESTIONS[Math.min(state.idx, ACTIVE_QUESTIONS.length - 1)];
        setFeedback(
          won ? "good" : "bad",
          `${won ? `<div class="font-black text-lg">You cleared ${ACTIVE_BOOK.title} Quiz Arcade!</div>` : `<div class="font-black text-lg">Game over.</div>`}
           <div class="mt-2">Final score: <span class="font-black">${state.score}</span></div>
           <div class="mt-1">Rank: <span class="font-black">${calcRank(state.score)}</span></div>
           <div class="mt-2 text-xs opacity-80">Last reference shown: ${q.ref}</div>`
        );

        btnRestart.classList.remove("hidden");
        popConfetti();
      }

      function resetRun() {
        state = freshState();
        btnSound.textContent = "Sound: On";
        renderQuestion();
        writeSave();
      }

      function renderBookMap() {
        bookNodes.innerHTML = "";
        BOOK_ORDER.forEach((id, index) => {
          const book = BOOKS[id];
          const wrap = document.createElement("div");
          wrap.className = "book-node-wrap";
          wrap.style.left = book.pos.x + "%";
          wrap.style.top = book.pos.y + "%";

          const btn = document.createElement("button");
          btn.className = "book-node";
          if (id === ACTIVE_BOOK_ID) btn.classList.add("active");
          btn.setAttribute("aria-label", book.title);
          btn.title = book.title;
          btn.innerHTML = `<span>${index + 1}</span>`;
          btn.addEventListener("click", () => startNewGameWithBook(id));

          const label = document.createElement("div");
          label.className = "book-label";
          label.textContent = book.title;

          wrap.appendChild(btn);
          wrap.appendChild(label);
          bookNodes.appendChild(wrap);
        });

        const lastId = resolveBookId(localStorage.getItem(LAST_BOOK_KEY));
        selectedBookLabel.textContent = `Last: ${BOOKS[lastId].title}`;
      }

      function showBookMap() {
        renderBookMap();
        bookMap.classList.remove("hidden");
        bookMap.classList.add("flex");
      }

      function hideBookMap() {
        bookMap.classList.add("hidden");
        bookMap.classList.remove("flex");
      }

      function startNewGameWithBook(bookId) {
        const resolved = resolveBookId(bookId);
        setActiveBook(resolved);
        localStorage.setItem(LAST_BOOK_KEY, resolved);
        clearSave();
        resetRun();
        hideBookMap();
        hideMenu();
        startBgMusic(); // start BG music after user click
      }

      function showMenu() {
        hideBookMap();
        const saved = readSave();
        const lastBookId = resolveBookId(localStorage.getItem(LAST_BOOK_KEY));
        const savedBookId = saved ? resolveBookId(saved.bookId) : null;
        const menuBookId = savedBookId || lastBookId;

        bestScoreMenu.textContent = String(getBestScore(menuBookId));
        if (saved && !saved.finished && saved.lives > 0) {
          const total = saved.total ?? BOOKS[savedBookId].questions.length;
          if (saved.idx < total) {
            saveStatus.textContent = `${BOOKS[savedBookId].title}: Q ${saved.idx + 1}/${total}`;
            btnContinue.disabled = false;
            btnContinue.style.opacity = "1";
          } else {
            saveStatus.textContent = "None";
            btnContinue.disabled = true;
            btnContinue.style.opacity = "0.7";
          }
        } else {
          saveStatus.textContent = "None";
          btnContinue.disabled = true;
          btnContinue.style.opacity = "0.7";
        }
        menu.classList.remove("hidden");
      }

      function hideMenu() {
        menu.classList.add("hidden");
      }

      function startNewGame() {
        hideMenu();
        showBookMap();
      }

      function startContinue() {
        const saved = readSave();
        if (!saved) return;

        const savedBookId = resolveBookId(saved.bookId);
        setActiveBook(savedBookId);
        localStorage.setItem(LAST_BOOK_KEY, savedBookId);

        state = freshState();
        const total = saved.total ?? ACTIVE_QUESTIONS.length;
        state.idx = Math.max(0, Math.min(saved.idx ?? 0, total - 1));
        state.score = saved.score ?? 0;
        state.lives = saved.lives ?? 3;
        state.streak = saved.streak ?? 0;
        state.finished = !!saved.finished;
        state.gemCount = saved.gemCount ?? 9999;
        state.answered = false;

        renderQuestion();
        hideMenu();
        hideBookMap();
        startBgMusic(); // start BG music after user click
      }

      // HUD events
      btnNext.addEventListener("click", next);
      btnRestart.addEventListener("click", () => {
        clearSave();
        resetRun();
        startBgMusic();
      });

      btnReset.addEventListener("click", () => {
        showMenu();
      });

      btnNewGame.addEventListener("click", startNewGame);
      btnContinue.addEventListener("click", startContinue);
      btnCloseMap.addEventListener("click", () => {
        hideBookMap();
        showMenu();
      });

      btnAddGems.addEventListener("click", () => {
        state.gemCount += 25;
        renderMeta();
        popConfetti();
        beep("level");
      });

      btnHow.addEventListener("click", () => {
        modal.classList.remove("hidden");
        modal.classList.add("flex");
      });
      btnClose.addEventListener("click", () => {
        modal.classList.add("hidden");
        modal.classList.remove("flex");
      });
      modal.addEventListener("click", (e) => {
        if (e.target === modal) {
          modal.classList.add("hidden");
          modal.classList.remove("flex");
        }
      });

      btnSound.addEventListener("click", () => {
        state.sound = !state.sound;
        btnSound.textContent = state.sound ? "Sound: On" : "Sound: Off";
        if (state.sound) startBgMusic();
        else stopBgMusic();
        beep("level");
      });

      // Keyboard: A/B/C/D + Enter for next
      window.addEventListener("keydown", (e) => {
        const k = e.key.toUpperCase();
        if (state.finished) return;

        // If popup is open, any key closes it
        if (streakPop.classList.contains("flex")) {
          hideStreakPopup();
          return;
        }

        if (!state.answered && ["A","B","C","D"].includes(k)) {
          const btns = [...choices.querySelectorAll("button")];
          const idx = ["A","B","C","D"].indexOf(k);
          if (btns[idx]) btns[idx].click();
        } else if (state.answered && (e.key === "Enter" || e.key === " ")) {
          btnNext.click();
        }
      });

      // Start
      const initialBookId = resolveBookId(localStorage.getItem(LAST_BOOK_KEY));
      setActiveBook(initialBookId);
      state = freshState();
      bestScoreEl.textContent = String(getBestScore(initialBookId));
      bestScoreMenu.textContent = String(getBestScore(initialBookId));
      showMenu();
      renderQuestion();
    </script>
  </body>
</html>
