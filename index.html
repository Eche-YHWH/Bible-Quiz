<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Acts Quiz Arcade</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      :root{
        --ink:#4a2a14;
        --paper:#f6d9a6;
        --paper2:#f3c98a;
        --leather:#8b4f2a;
        --leather2:#6f3b1f;
        --gold:#ffcf4a;
        --gold2:#ffb229;
        --cream:#fff2d1;
      }

      /* soft game bg */
      .bg-art {
        background:
          radial-gradient(1200px 700px at 30% 10%, rgba(255, 223, 127, 0.35), transparent 60%),
          radial-gradient(900px 600px at 80% 30%, rgba(255, 128, 200, 0.18), transparent 55%),
          radial-gradient(900px 700px at 20% 75%, rgba(80, 220, 255, 0.18), transparent 55%),
          linear-gradient(180deg, #f2e5c8, #e8d4aa);
      }

      /* top HUD pill shadow */
      .hud {
        box-shadow: 0 10px 18px rgba(0,0,0,0.25);
      }

      /* parchment */
      .paper {
        background: linear-gradient(180deg, var(--paper), var(--paper2));
        box-shadow: 0 14px 28px rgba(0,0,0,0.25);
        border: 2px solid rgba(124,72,34,0.25);
      }

      /* leather base */
      .leather {
        background: linear-gradient(180deg, var(--leather), var(--leather2));
        border: 2px solid rgba(255,255,255,0.12);
        box-shadow: inset 0 0 0 2px rgba(0,0,0,0.08), 0 14px 28px rgba(0,0,0,0.25);
      }

      .stitch {
        border: 2px dashed rgba(255,255,255,0.18);
      }

      /* answer buttons */
      .answer {
        background: linear-gradient(180deg, var(--gold), var(--gold2));
        border: 2px solid rgba(90, 40, 10, 0.25);
        box-shadow: inset 0 2px 0 rgba(255,255,255,0.65), 0 10px 0 rgba(0,0,0,0.15);
        color: var(--ink);
      }
      .answer:hover { filter: brightness(1.02); }
      .answer:active { transform: translateY(2px); box-shadow: inset 0 2px 0 rgba(255,255,255,0.55), 0 8px 0 rgba(0,0,0,0.15); }
      .answer[disabled]{ opacity: 0.75; filter: saturate(0.9); }

      .badge {
        background: linear-gradient(180deg, #ffe7a8, #ffd066);
        border: 2px solid rgba(90,40,10,0.22);
        box-shadow: inset 0 2px 0 rgba(255,255,255,0.65), 0 8px 14px rgba(0,0,0,0.18);
        color: var(--ink);
      }

      .iconbtn {
        background: linear-gradient(180deg, #ffcf4a, #ffae2a);
        border: 2px solid rgba(90,40,10,0.22);
        box-shadow: inset 0 2px 0 rgba(255,255,255,0.65), 0 10px 0 rgba(0,0,0,0.14);
      }
      .iconbtn:active{ transform: translateY(2px); box-shadow: inset 0 2px 0 rgba(255,255,255,0.55), 0 8px 0 rgba(0,0,0,0.14); }

      /* progress bar */
      .track {
        background: linear-gradient(180deg, #a0602f, #804620);
        box-shadow: inset 0 2px 0 rgba(255,255,255,0.18);
        border: 2px solid rgba(90,40,10,0.18);
      }
      .trackFill {
        background: linear-gradient(180deg, #ffd86b, #ffb836);
        box-shadow: inset 0 2px 0 rgba(255,255,255,0.35);
      }

      .confetti {
        position: fixed;
        inset: 0;
        pointer-events: none;
        overflow: hidden;
        z-index: 50;
      }
      .confetti i {
        position: absolute;
        width: 10px;
        height: 18px;
        opacity: 0.9;
        transform: translateY(-20px) rotate(0deg);
        animation: fall 900ms linear forwards;
        border-radius: 3px;
      }
      @keyframes fall {
        to { transform: translateY(110vh) rotate(360deg); opacity: 1; }
      }

      .shake { animation: shake 0.35s ease-in-out; }
      @keyframes shake {
        0% { transform: translateX(0); }
        25% { transform: translateX(-6px); }
        50% { transform: translateX(6px); }
        75% { transform: translateX(-4px); }
        100% { transform: translateX(0); }
      }
    </style>
  </head>

  <body class="min-h-screen bg-art">
    <div id="confetti" class="confetti hidden"></div>

    <!-- Background music -->
    <audio id="bgMusic" src="./fairy-tale-loop-275534.mp3" loop preload="auto"></audio>

    <!-- Menu Screen -->
    <div id="menu" class="fixed inset-0 z-40 flex items-center justify-center bg-black/50 p-4">
      <div class="paper w-full max-w-md rounded-3xl p-6 text-[color:var(--ink)]">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-2xl font-black">Acts Quiz Arcade</h2>
            <p class="mt-1 text-sm font-semibold opacity-80">Pick a mode.</p>
          </div>
          <div class="text-3xl">ü™Ω</div>
        </div>

        <div class="mt-5 grid gap-3">
          <button id="btnNewGame" class="answer w-full rounded-2xl px-4 py-4 font-black text-lg">New game</button>
          <button id="btnContinue" class="answer w-full rounded-2xl px-4 py-4 font-black text-lg">Continue</button>
        </div>

        <div class="mt-4 badge rounded-2xl px-4 py-3 text-sm font-semibold">
          <div class="flex items-center justify-between">
            <span>Best</span>
            <span id="bestScoreMenu" class="font-black">0</span>
          </div>
          <div class="mt-2 flex items-center justify-between">
            <span>Saved run</span>
            <span id="saveStatus" class="font-black">None</span>
          </div>
        </div>

        <p class="mt-4 text-xs font-semibold opacity-75">
          Tip: Keep a streak. Every 3 correct gives a bonus.
        </p>
      </div>
    </div>

    <!-- Angel popup -->
    <div id="angelPop" class="fixed inset-0 z-40 hidden items-center justify-center p-4">
      <div class="paper max-w-sm w-full rounded-3xl p-5 text-center text-[color:var(--ink)]">
        <div class="text-5xl">üòá</div>
        <div class="mt-2 text-xl font-black">Streak bonus!</div>
        <div class="mt-1 text-sm font-semibold opacity-80">Keep going.</div>
      </div>
    </div>

    <main class="mx-auto max-w-md px-4 py-6">
      <!-- HUD -->
      <header class="hud flex items-center justify-between rounded-2xl bg-white/30 backdrop-blur-sm px-3 py-2 border border-white/30">
        <div class="flex items-center gap-2">
          <div class="grid h-9 w-9 place-items-center rounded-xl bg-cyan-300/90 border border-white/40 shadow">
            <span class="text-xl">üíé</span>
          </div>
          <div class="badge rounded-xl px-3 py-2 font-extrabold leading-none">
            <span id="gemCount">9999</span>
          </div>
          <button id="btnAddGems" class="iconbtn grid h-9 w-9 place-items-center rounded-xl" title="Bonus">
            <span class="text-lg">Ôºã</span>
          </button>
        </div>

        <div class="flex items-center gap-2">
          <button id="btnReset" class="iconbtn grid h-9 w-9 place-items-center rounded-xl" title="Restart">
            <span class="text-lg">‚Ü©</span>
          </button>
          <button id="btnHow" class="iconbtn grid h-9 w-9 place-items-center rounded-xl" title="How to play">
            <span class="text-lg">‚öô</span>
          </button>
        </div>
      </header>

      <!-- Progress -->
      <section class="mt-4">
        <div class="flex items-center gap-3">
          <span class="text-2xl">‚≠ê</span>
          <div class="track relative h-4 flex-1 rounded-full overflow-hidden">
            <div id="progressFill" class="trackFill absolute left-0 top-0 h-full w-0"></div>
          </div>
          <span class="text-2xl">‚≠ê</span>
        </div>
        <div class="mt-2 flex items-center justify-between text-sm text-[color:var(--ink)] font-extrabold">
          <span id="statLevelName">New Fire</span>
          <span id="statProgress">1/30</span>
        </div>
      </section>

      <!-- Question parchment -->
      <section id="paperCard" class="paper mt-4 rounded-3xl px-5 py-6">
        <div class="text-[color:var(--ink)]">
          <p class="text-3xl font-black leading-tight" id="qText">Loading...</p>
        </div>

        <div class="mt-4 flex items-center justify-between">
          <!-- hearts -->
          <div class="flex items-center gap-2">
            <div id="statLives" class="flex gap-1"></div>
          </div>

          <!-- timer badge (visual only) -->
          <div class="badge rounded-2xl px-3 py-2 flex items-center gap-2">
            <span class="text-lg">‚è±</span>
            <span class="font-black" id="timerLabel">15s</span>
          </div>
        </div>
      </section>

      <!-- Answers leather board -->
      <section id="board" class="leather mt-4 rounded-3xl p-4">
        <div class="stitch rounded-2xl p-3">
          <div id="choices" class="grid gap-3"></div>
        </div>

        <div id="feedback" class="mt-4 hidden rounded-2xl px-4 py-3 text-sm"></div>

        <div class="mt-4 flex items-center gap-2">
          <button id="btnNext" class="hidden answer w-full rounded-2xl px-4 py-3 font-black text-lg">Next</button>
          <button id="btnRestart" class="hidden answer w-full rounded-2xl px-4 py-3 font-black text-lg">Play again</button>
        </div>

        <div class="mt-3 flex items-center justify-between">
          <div class="badge rounded-2xl px-3 py-2">
            <span class="font-black">Score:</span> <span id="statScore" class="font-black">0</span>
            <span class="opacity-70"> | </span>
            <span class="font-black">Streak:</span> <span id="statStreak" class="font-black">0</span>
          </div>

          <button id="btnSound" class="badge rounded-2xl px-3 py-2 font-black">Sound: On</button>
        </div>

        <div class="mt-3 text-xs text-white/75">
          <span class="font-semibold">Best:</span> <span id="bestScore">0</span>
          <span class="opacity-70"> | </span>
          <span class="font-semibold">Rank:</span> <span id="rank">Fresh Learner</span>
        </div>
      </section>

      <!-- Modal -->
      <div id="modal" class="fixed inset-0 hidden items-center justify-center bg-black/60 p-4 z-40">
        <div class="paper w-full max-w-lg rounded-3xl p-5">
          <div class="flex items-start justify-between gap-3 text-[color:var(--ink)]">
            <div>
              <h3 class="text-lg font-black">How to play</h3>
              <p class="text-sm opacity-80 mt-1">Quick rules so you can start fast.</p>
            </div>
            <button id="btnClose" class="badge rounded-xl px-3 py-2 font-black">Close</button>
          </div>

          <ul class="mt-4 space-y-2 text-sm text-[color:var(--ink)] font-semibold list-disc pl-5">
            <li>30 questions split into 5 levels (6 each).</li>
            <li>Correct answer: +10 points.</li>
            <li>Wrong answer: lose 1 life (you have 3).</li>
            <li>Streak bonus: every 3 correct in a row gives +5.</li>
            <li>Level-up pops confetti. Finish all 30 to get your rank.</li>
            <li>Keyboard: A/B/C/D to answer, Enter for next.</li>
          </ul>
        </div>
      </div>
    </main>

    <script>
      // ---------- Audio (FX + BG music) ----------
      const AUDIO = {
        correct: "./correct-156911.mp3",
        streak: "./correct-472358.mp3",
      };

      // ---------- Data ----------
      const QUESTIONS_PER_LEVEL = 6;

      const LEVELS = {
        1: { name: "New Fire (Acts 1-6)" },
        2: { name: "The Way Spreads (Acts 7-12)" },
        3: { name: "Across Cities (Acts 13-18)" },
        4: { name: "Truth on Trial (Acts 19-24)" },
        5: { name: "Rome at Last (Acts 25-28)" },
      };

      const QUESTIONS = [
        // Level 1
        { level: 1, question: "Before Jesus ascended, what did He tell the disciples to wait for in Jerusalem?", options: { A: "More teachings", B: "The Holy Spirit", C: "Bread and wine", D: "A new king" }, answer: "B", ref: "Acts 1:4-5" },
        { level: 1, question: "Who replaced Judas as the 12th apostle?", options: { A: "Matthias", B: "Barnabas", C: "Paul", D: "Silas" }, answer: "A", ref: "Acts 1:26" },
        { level: 1, question: "What happened on the day of Pentecost?", options: { A: "Earthquake", B: "The Holy Spirit came with tongues of fire", C: "A flood", D: "Angels appeared" }, answer: "B", ref: "Acts 2:1-4" },
        { level: 1, question: "Peter‚Äôs first sermon led to how many people being added in one day?", options: { A: "70", B: "120", C: "3,000", D: "5,000" }, answer: "C", ref: "Acts 2:41" },
        { level: 1, question: "What miracle did Peter and John do at the Beautiful Gate?", options: { A: "Healed a blind man", B: "Healed a lame man", C: "Raised a dead man", D: "Cast out a legion" }, answer: "B", ref: "Acts 3:1-10" },
        { level: 1, question: "Why were deacons chosen in Acts 6?", options: { A: "To lead worship", B: "To care for widows fairly", C: "To write letters", D: "To arrest criminals" }, answer: "B", ref: "Acts 6:1-6" },

        // Level 2
        { level: 2, question: "Who was the first Christian martyr?", options: { A: "James", B: "Stephen", C: "Peter", D: "Philip" }, answer: "B", ref: "Acts 7:54-60" },
        { level: 2, question: "Who preached in Samaria and many believed?", options: { A: "Philip", B: "Thomas", C: "Andrew", D: "Matthew" }, answer: "A", ref: "Acts 8:5-8" },
        { level: 2, question: "Who was baptized after reading Isaiah with Philip?", options: { A: "A Roman soldier", B: "An Ethiopian eunuch", C: "A synagogue ruler", D: "A tax collector" }, answer: "B", ref: "Acts 8:26-39" },
        { level: 2, question: "Who met Jesus on the road to Damascus and became an apostle?", options: { A: "Saul", B: "Apollos", C: "Timothy", D: "Mark" }, answer: "A", ref: "Acts 9:1-6" },
        { level: 2, question: "Who was raised from the dead by Peter in Joppa?", options: { A: "Tabitha (Dorcas)", B: "Mary Magdalene", C: "Jezebel", D: "Martha" }, answer: "A", ref: "Acts 9:36-41" },
        { level: 2, question: "Who was the centurion whose household received the Holy Spirit?", options: { A: "Cornelius", B: "Julius", C: "Longinus", D: "Tertullus" }, answer: "A", ref: "Acts 10:1-2" },

        // Level 3
        { level: 3, question: "Who went with Paul on his first missionary journey?", options: { A: "Silas", B: "Barnabas", C: "Luke", D: "Peter" }, answer: "B", ref: "Acts 13:2-3" },
        { level: 3, question: "What was the main debate at the Jerusalem Council (Acts 15)?", options: { A: "Should believers keep the Sabbath?", B: "Should Gentiles be circumcised to be saved?", C: "Should Rome be resisted?", D: "Should the church build temples?" }, answer: "B", ref: "Acts 15:1-11" },
        { level: 3, question: "In Philippi, who was the first convert mentioned, a seller of purple?", options: { A: "Lydia", B: "Dorcas", C: "Priscilla", D: "Drusilla" }, answer: "A", ref: "Acts 16:14-15" },
        { level: 3, question: "In Philippi, Paul and Silas sang hymns in prison. What happened next?", options: { A: "Fire came down", B: "An earthquake opened the doors", C: "The guards ran away", D: "Paul fainted" }, answer: "B", ref: "Acts 16:25-26" },
        { level: 3, question: "At Athens, where did Paul preach about the 'Unknown God'?", options: { A: "The Temple", B: "The marketplace only", C: "The Areopagus", D: "A prison courtyard" }, answer: "C", ref: "Acts 17:22-23" },
        { level: 3, question: "In Acts 18, who explained the way of God more accurately to Apollos?", options: { A: "Aquila and Priscilla", B: "James and John", C: "Peter and Andrew", D: "Philip and Stephen" }, answer: "A", ref: "Acts 18:26" },

        // Level 4
        { level: 4, question: "In Ephesus, people burned what after turning from sin?", options: { A: "Their clothes", B: "Their magic books", C: "Their fishing nets", D: "Their scrolls of law" }, answer: "B", ref: "Acts 19:19" },
        { level: 4, question: "Who was the young man who fell from a window but was revived by Paul?", options: { A: "Titus", B: "Eutychus", C: "Onesimus", D: "Simeon" }, answer: "B", ref: "Acts 20:9-10" },
        { level: 4, question: "Why was Paul arrested in Jerusalem?", options: { A: "He stole money", B: "He was accused of defiling the temple", C: "He attacked a soldier", D: "He refused to pay taxes" }, answer: "B", ref: "Acts 21:27-36" },
        { level: 4, question: "What was Paul‚Äôs citizenship that protected him from being beaten unlawfully?", options: { A: "Greek", B: "Roman", C: "Egyptian", D: "Syrian" }, answer: "B", ref: "Acts 22:25-28" },
        { level: 4, question: "Paul said he was on trial because of hope in what doctrine?", options: { A: "Prosperity", B: "Resurrection of the dead", C: "Angels", D: "The law of Moses" }, answer: "B", ref: "Acts 23:6" },
        { level: 4, question: "Who trembled when Paul spoke about righteousness and judgment to come?", options: { A: "Felix", B: "Cornelius", C: "Stephen", D: "Gamaliel" }, answer: "A", ref: "Acts 24:24-25" },

        // Level 5
        { level: 5, question: "To whom did Paul appeal, using his rights as a Roman citizen?", options: { A: "The Sanhedrin", B: "Caesar", C: "The high priest", D: "The centurion" }, answer: "B", ref: "Acts 25:10-12" },
        { level: 5, question: "Which king heard Paul‚Äôs defense and said 'Almost you persuade me'?", options: { A: "Herod", B: "Agrippa", C: "Caesar", D: "Nero" }, answer: "B", ref: "Acts 26:28" },
        { level: 5, question: "During the storm at sea, what did Paul say God promised about everyone on the ship?", options: { A: "Many would die", B: "All would be saved", C: "Only Paul would live", D: "The ship would not break" }, answer: "B", ref: "Acts 27:22-24" },
        { level: 5, question: "After the shipwreck, which island did they land on?", options: { A: "Patmos", B: "Cyprus", C: "Malta", D: "Crete" }, answer: "C", ref: "Acts 28:1" },
        { level: 5, question: "On Malta, what happened to Paul when a viper bit him?", options: { A: "He died instantly", B: "His hand swelled badly", C: "Nothing happened", D: "He became blind" }, answer: "C", ref: "Acts 28:3-6" },
        { level: 5, question: "How does the book of Acts end (final setting)?", options: { A: "Paul in a palace", B: "Paul in prison in Jerusalem", C: "Paul preaching in Rome under house arrest", D: "Peter ruling the church" }, answer: "C", ref: "Acts 28:30-31" },
      ];

      // ---------- State ----------
      let state;
      function freshState() {
        return {
          idx: 0,
          score: 0,
          lives: 3,
          streak: 0,
          answered: false,
          finished: false,
          sound: true,     // controls FX + BG music
          gemCount: 9999,
        };
      }

      // ---------- DOM ----------
      const el = (id) => document.getElementById(id);
      const qText = el("qText");
      const choices = el("choices");
      const feedback = el("feedback");
      const btnNext = el("btnNext");
      const btnRestart = el("btnRestart");
      const btnReset = el("btnReset");
      const btnHow = el("btnHow");
      const modal = el("modal");
      const btnClose = el("btnClose");
      const btnSound = el("btnSound");
      const confetti = el("confetti");
      const progressFill = el("progressFill");
      const statProgress = el("statProgress");
      const statLives = el("statLives");
      const statScore = el("statScore");
      const statStreak = el("statStreak");
      const statLevelName = el("statLevelName");
      const bestScoreEl = el("bestScore");
      const rankEl = el("rank");
      const gemCountEl = el("gemCount");
      const btnAddGems = el("btnAddGems");
      const menu = el("menu");
      const btnNewGame = el("btnNewGame");
      const btnContinue = el("btnContinue");
      const bestScoreMenu = el("bestScoreMenu");
      const saveStatus = el("saveStatus");
      const angelPop = el("angelPop");
      const bgMusic = el("bgMusic");

      // ---------- Sound ----------
      let audioCtx;
      function beep(type) {
        if (!state.sound) return;
        try {
          audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
          const o = audioCtx.createOscillator();
          const g = audioCtx.createGain();
          o.type = "sine";
          o.frequency.value = type === "good" ? 660 : type === "level" ? 880 : 220;
          g.gain.value = 0.06;
          o.connect(g); g.connect(audioCtx.destination);
          o.start();
          o.stop(audioCtx.currentTime + 0.12);
        } catch (_) {}
      }

      function playFX(kind) {
        if (!state.sound) return;
        try {
          const a = new Audio(AUDIO[kind]);
          a.volume = 0.9;
          a.play().catch(() => {
            beep(kind === "streak" ? "level" : "good");
          });
        } catch (e) {
          beep(kind === "streak" ? "level" : "good");
        }
      }

      function startBgMusic() {
        if (!state.sound) return;
        if (!bgMusic) return;
        bgMusic.volume = 0.32;
        bgMusic.play().catch(() => {
          // Autoplay may be blocked until a click, this is fine.
        });
      }

      function stopBgMusic() {
        if (!bgMusic) return;
        bgMusic.pause();
        bgMusic.currentTime = 0;
      }

      // ---------- Confetti ----------
      function popConfetti() {
        confetti.innerHTML = "";
        confetti.classList.remove("hidden");

        const colors = ["#22c55e", "#60a5fa", "#f472b6", "#fbbf24", "#a78bfa", "#34d399"];
        const count = 80;

        for (let i = 0; i < count; i++) {
          const piece = document.createElement("i");
          const left = Math.random() * 100;
          const delay = Math.random() * 120;
          const color = colors[Math.floor(Math.random() * colors.length)];
          const w = 6 + Math.random() * 8;
          const h = 10 + Math.random() * 14;

          piece.style.left = left + "vw";
          piece.style.top = "-20px";
          piece.style.background = color;
          piece.style.width = w + "px";
          piece.style.height = h + "px";
          piece.style.animationDelay = delay + "ms";
          piece.style.transform = `translateY(-20px) rotate(${Math.random() * 360}deg)`;

          confetti.appendChild(piece);
        }

        setTimeout(() => confetti.classList.add("hidden"), 1200);
      }

      // ---------- Storage / rank ----------
      const BEST_KEY = "acts_quiz_best_v3";
      const SAVE_KEY = "acts_quiz_save_v3";

      function getBestScore() {
        return Number(localStorage.getItem(BEST_KEY) || "0");
      }
      function setBestScore(v) {
        localStorage.setItem(BEST_KEY, String(v));
      }

      function readSave() {
        try {
          const raw = localStorage.getItem(SAVE_KEY);
          return raw ? JSON.parse(raw) : null;
        } catch {
          return null;
        }
      }
      function writeSave() {
        try {
          const payload = {
            idx: state.idx,
            score: state.score,
            lives: state.lives,
            streak: state.streak,
            finished: state.finished,
            gemCount: state.gemCount,
          };
          localStorage.setItem(SAVE_KEY, JSON.stringify(payload));
        } catch {}
      }
      function clearSave() {
        localStorage.removeItem(SAVE_KEY);
      }

      function calcRank(score) {
        // Base score is 30 * 10 = 300, plus streak bonuses
        if (score >= 280) return "Acts Grandmaster";
        if (score >= 210) return "Kingdom Builder";
        if (score >= 140) return "Growing Disciple";
        return "Fresh Learner";
      }

      // ---------- UI helpers ----------
      function renderLives() {
        statLives.innerHTML = "";
        for (let i = 0; i < 3; i++) {
          const span = document.createElement("span");
          span.className = "text-2xl";
          span.textContent = i < state.lives ? "‚ù§" : "üñ§";
          statLives.appendChild(span);
        }
      }

      function setFeedback(type, html) {
        feedback.classList.remove("hidden");
        feedback.className = "mt-4 rounded-2xl px-4 py-3 text-sm";
        if (type === "good") {
          feedback.classList.add("bg-emerald-500/20", "border", "border-emerald-200/30", "text-white");
        } else {
          feedback.classList.add("bg-rose-500/20", "border", "border-rose-200/30", "text-white");
        }
        feedback.innerHTML = html;
      }

      function lockChoices() {
        [...choices.querySelectorAll("button")].forEach((b) => (b.disabled = true));
      }

      function renderProgress() {
        const total = QUESTIONS.length;
        const current = state.idx + 1;
        const pct = Math.round(((current - 1) / total) * 100);
        progressFill.style.width = pct + "%";
        statProgress.textContent = `${current}/${total}`;
      }

      function renderMeta() {
        const q = QUESTIONS[state.idx];
        statLevelName.textContent = LEVELS[q.level].name;
        statScore.textContent = String(state.score);
        statStreak.textContent = String(state.streak);
        bestScoreEl.textContent = String(getBestScore());
        rankEl.textContent = calcRank(state.score);
        gemCountEl.textContent = String(state.gemCount);
      }

      function renderQuestion() {
        const q = QUESTIONS[state.idx];

        qText.textContent = q.question; // no "1/30" prefix here
        choices.innerHTML = "";
        feedback.classList.add("hidden");
        btnNext.classList.add("hidden");
        btnRestart.classList.add("hidden");

        const letters = ["A", "B", "C", "D"];
        for (const letter of letters) {
          const label = q.options[letter];
          const btn = document.createElement("button");
          btn.className = "answer w-full rounded-2xl px-4 py-4 font-black text-lg text-left";
          btn.innerHTML = `${letter}. ${label}`;
          btn.addEventListener("click", () => answer(letter));
          choices.appendChild(btn);
        }

        renderLives();
        renderProgress();
        renderMeta();
      }

      function showAngelPopup() {
        angelPop.classList.remove("hidden");
        angelPop.classList.add("flex");
        setTimeout(() => {
          angelPop.classList.add("hidden");
          angelPop.classList.remove("flex");
        }, 900);
      }

      function answer(letter) {
        if (state.answered || state.finished) return;

        const q = QUESTIONS[state.idx];
        state.answered = true;
        lockChoices();

        const correct = letter === q.answer;

        if (correct) {
          state.score += 10;
          state.streak += 1;

          if (state.streak % 3 === 0) {
            state.score += 5;
            setFeedback("good", `<div class="font-black">Correct! +10</div><div class="mt-1">Streak bonus: +5</div>`);
            playFX("streak");
            showAngelPopup();
            popConfetti();
          } else {
            setFeedback("good", `<div class="font-black">Correct! +10</div>`);
            playFX("correct");
          }
        } else {
          state.lives -= 1;
          state.streak = 0;

          const correctText = q.options[q.answer];
          setFeedback(
            "bad",
            `<div class="font-black">Wrong. -1 life</div><div class="mt-1">Correct: <span class="font-black">${q.answer}. ${correctText}</span></div><div class="mt-2 text-xs opacity-80">Reference: ${q.ref}</div>`
          );

          const card = document.getElementById("paperCard");
          card.classList.add("shake");
          setTimeout(() => card.classList.remove("shake"), 380);

          beep("bad");
        }

        renderLives();
        renderMeta();

        if (state.lives <= 0) {
          endGame(false);
          return;
        }

        // Level-up confetti after each level
        const nextIdx = state.idx + 1;
        if (nextIdx % QUESTIONS_PER_LEVEL === 0 && nextIdx < QUESTIONS.length) {
          beep("level");
          popConfetti();
        }

        btnNext.classList.remove("hidden");
        writeSave();
      }

      function next() {
        if (!state.answered || state.finished) return;

        state.idx += 1;
        state.answered = false;

        if (state.idx >= QUESTIONS.length) {
          endGame(true);
          return;
        }

        renderQuestion();
        writeSave();
      }

      function endGame(won) {
        state.finished = true;
        clearSave();
        btnNext.classList.add("hidden");
        choices.innerHTML = "";

        const best = getBestScore();
        if (state.score > best) setBestScore(state.score);

        renderMeta();

        const q = QUESTIONS[Math.min(state.idx, QUESTIONS.length - 1)];
        setFeedback(
          won ? "good" : "bad",
          `${won ? `<div class="font-black text-lg">You cleared Acts Quiz Arcade!</div>` : `<div class="font-black text-lg">Game over.</div>`}
           <div class="mt-2">Final score: <span class="font-black">${state.score}</span></div>
           <div class="mt-1">Rank: <span class="font-black">${calcRank(state.score)}</span></div>
           <div class="mt-2 text-xs opacity-80">Last reference shown: ${q.ref}</div>`
        );

        btnRestart.classList.remove("hidden");
        popConfetti();
      }

      function resetRun() {
        state = freshState();
        btnSound.textContent = "Sound: On";
        renderQuestion();
        writeSave();
      }

      function showMenu() {
        bestScoreMenu.textContent = String(getBestScore());
        const saved = readSave();
        if (saved && !saved.finished && saved.lives > 0 && saved.idx < QUESTIONS.length) {
          saveStatus.textContent = `Q ${saved.idx + 1}/${QUESTIONS.length}`;
          btnContinue.disabled = false;
          btnContinue.style.opacity = "1";
        } else {
          saveStatus.textContent = "None";
          btnContinue.disabled = true;
          btnContinue.style.opacity = "0.7";
        }
        menu.classList.remove("hidden");
      }

      function hideMenu() {
        menu.classList.add("hidden");
      }

      function startNewGame() {
        clearSave();
        resetRun();
        hideMenu();
        startBgMusic(); // start BG music after user click
      }

      function startContinue() {
        const saved = readSave();
        if (!saved) return;

        state = freshState();
        state.idx = Math.max(0, Math.min(saved.idx ?? 0, QUESTIONS.length - 1));
        state.score = saved.score ?? 0;
        state.lives = saved.lives ?? 3;
        state.streak = saved.streak ?? 0;
        state.finished = !!saved.finished;
        state.gemCount = saved.gemCount ?? 9999;
        state.answered = false;

        renderQuestion();
        hideMenu();
        startBgMusic(); // start BG music after user click
      }

      // HUD events
      btnNext.addEventListener("click", next);
      btnRestart.addEventListener("click", () => {
        clearSave();
        resetRun();
        startBgMusic();
      });

      btnReset.addEventListener("click", () => {
        showMenu();
      });

      btnNewGame.addEventListener("click", startNewGame);
      btnContinue.addEventListener("click", startContinue);

      btnAddGems.addEventListener("click", () => {
        state.gemCount += 25;
        renderMeta();
        popConfetti();
        beep("level");
      });

      btnHow.addEventListener("click", () => {
        modal.classList.remove("hidden");
        modal.classList.add("flex");
      });
      btnClose.addEventListener("click", () => {
        modal.classList.add("hidden");
        modal.classList.remove("flex");
      });
      modal.addEventListener("click", (e) => {
        if (e.target === modal) {
          modal.classList.add("hidden");
          modal.classList.remove("flex");
        }
      });

      btnSound.addEventListener("click", () => {
        state.sound = !state.sound;
        btnSound.textContent = state.sound ? "Sound: On" : "Sound: Off";
        if (state.sound) startBgMusic();
        else stopBgMusic();
        beep("level");
      });

      // Keyboard: A/B/C/D + Enter for next
      window.addEventListener("keydown", (e) => {
        const k = e.key.toUpperCase();
        if (state.finished) return;

        if (!state.answered && ["A","B","C","D"].includes(k)) {
          const btns = [...choices.querySelectorAll("button")];
          const idx = ["A","B","C","D"].indexOf(k);
          if (btns[idx]) btns[idx].click();
        } else if (state.answered && (e.key === "Enter" || e.key === " ")) {
          btnNext.click();
        }
      });

      // Start
      state = freshState();
      bestScoreEl.textContent = String(getBestScore());
      bestScoreMenu.textContent = String(getBestScore());
      showMenu();
      renderQuestion();
    </script>
  </body>
</html>
